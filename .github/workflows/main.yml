name: AnyDesk Official CLI Setup (Auto Renew ID)

on:
  workflow_dispatch:

jobs:
  run-anydesk:
    runs-on: windows-latest
    steps:
      - name: 1. Install & Connect Tailscale
        shell: powershell
        run: |
          $tsUrl = "https://pkgs.tailscale.com/stable/tailscale-setup-1.92.3-amd64.msi"
          $installerPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri $tsUrl -OutFile $installerPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$installerPath`"", "/quiet", "/norestart" -Wait
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --hostname=gh-runner-${{ github.run_id }}
          $tsIP = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          "TAILSCALE_IP=$tsIP" | Out-File -Append $env:GITHUB_ENV

      - name: 2. Install AnyDesk
        shell: cmd
        run: |
          powershell -Command "Invoke-WebRequest -Uri 'https://download.anydesk.com/AnyDesk.exe' -OutFile 'AnyDesk.exe'"
          AnyDesk.exe --install "C:\AnyDesk" --start-with-win --silent
          powershell -Command "Start-Sleep -Seconds 20"

      - name: 3. AnyDesk ID Loop (55min Renew)
        shell: cmd
        run: |
          set AD=C:\AnyDesk\AnyDesk.exe

          :MAIN
          start "" "%AD%" --start
          timeout /t 10 >nul

          for /f "delims=" %%i in ('"%AD%" --get-id') do set ID=%%i
          if "%ID%"=="" goto MAIN
          if "%ID%"=="0" goto MAIN

          echo disalardp | "%AD%" --set-password _full_access
          echo ANYDESK_ID=%ID% >> %GITHUB_ENV%
          echo ACTIVE ID: %ID%

          timeout /t 3300 >nul

          sc stop AnyDesk >nul 2>&1
          taskkill /f /im AnyDesk.exe >nul 2>&1
          rmdir /s /q "%ProgramData%\AnyDesk" >nul 2>&1

          goto MAIN

      - name: 4. Keep Alive
        shell: powershell
        run: |
          $endTime = (Get-Date).AddHours(6)
          while ((Get-Date) -lt $endTime) {
              Write-Host "Online | ID: $env:ANYDESK_ID | $(Get-Date)"
              Start-Sleep -Seconds 60
          }
